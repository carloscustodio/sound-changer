<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tauri + Yew App</title>
    <link data-trunk rel="css" href="styles.css" />
    <link data-trunk rel="copy-dir" href="public" />
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  </head>
  <body>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        // Wait a bit for the Yew app to render
        setTimeout(() => {
          const dragBounds = document.querySelector('.devices-container') || document.body;
          interact('.draggable-tile').draggable({
            inertia: true,
            modifiers: [
              interact.modifiers.restrictRect({
                restriction: dragBounds,
                endOnly: true
              })
            ],
            listeners: {
              start (event) {
                const target = event.target;
                target.style.zIndex = '1000';
                target.style.cursor = 'grabbing';
                // Remember origin list id and index to allow precise revert
                const originList = target.closest('.device-list');
                target.setAttribute('data-origin-parent', originList ? (originList.id || '') : '');
                if (originList) {
                  const siblings = Array.from(originList.querySelectorAll('.draggable-tile'));
                  const originIndex = siblings.indexOf(target);
                  target.setAttribute('data-origin-index', String(originIndex));
                } else {
                  target.removeAttribute('data-origin-index');
                }
              },
              move (event) {
                const target = event.target;
                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;
                target.style.transform = `translate(${x}px, ${y}px)`;
                target.setAttribute('data-x', x);
                target.setAttribute('data-y', y);
              },
              end (event) {
                const target = event.target;
                target.style.zIndex = '';
                target.style.cursor = 'grab';
                const dropped = target.getAttribute('data-dropped') === 'true';
                if (!dropped) {
                  // Revert transform and reinsert at original index
                  target.style.transform = '';
                  target.removeAttribute('data-x');
                  target.removeAttribute('data-y');
                  const parentId = target.getAttribute('data-origin-parent');
                  const indexStr = target.getAttribute('data-origin-index');
                  if (parentId) {
                    const origin = document.getElementById(parentId);
                    if (origin) {
                      const idx = parseInt(indexStr || '-1', 10);
                      const tiles = Array.from(origin.querySelectorAll('.draggable-tile'));
                      if (idx >= 0 && idx < tiles.length) {
                        origin.insertBefore(target, tiles[idx]);
                      } else {
                        origin.appendChild(target);
                      }
                    }
                  }
                } else {
                  target.removeAttribute('data-dropped');
                }
              }
            }
          });

          // Dropzones with 50% overlap acceptance
          interact('.device-list').dropzone({
            overlap: 0.5,
            ondropactivate (event) {
              event.target.classList.add('drop-active');
            },
            ondragenter (event) {
              event.target.classList.add('drop-target');
              // Notify Yew that a tile is hovering over this list
              const tile = event.relatedTarget;
              const dropzone = event.target;
              const evt = new CustomEvent('tile:over', {
                detail: {
                  tileId: tile.getAttribute('data-tile-id') || null,
                  overListId: dropzone.id || null
                }
              });
              window.dispatchEvent(evt);
            },
            ondragleave (event) {
              event.target.classList.remove('drop-target');
              const tile = event.relatedTarget;
              const dropzone = event.target;
              const evt = new CustomEvent('tile:leave', {
                detail: {
                  tileId: tile.getAttribute('data-tile-id') || null,
                  fromListId: dropzone.id || null
                }
              });
              window.dispatchEvent(evt);
            },
            ondrop (event) {
              const tile = event.relatedTarget;
              const dropzone = event.target;
              tile.style.transform = '';
              tile.removeAttribute('data-x');
              tile.removeAttribute('data-y');
              dropzone.appendChild(tile);
              tile.setAttribute('data-dropped', 'true');
              tile.setAttribute('data-origin-parent', dropzone.id || '');
              const tilesNow = Array.from(dropzone.querySelectorAll('.draggable-tile'));
              tile.setAttribute('data-origin-index', String(tilesNow.indexOf(tile)));

              // Emit a custom event so Yew can react if desired
              const evt = new CustomEvent('tile:dropped', {
                detail: {
                  tileId: tile.getAttribute('data-tile-id') || null,
                  toListId: dropzone.id || null
                }
              });
              window.dispatchEvent(evt);
            },
            ondropdeactivate (event) {
              event.target.classList.remove('drop-active');
              event.target.classList.remove('drop-target');
            }
          });
        }, 500);
      });
    </script>
  </body>
</html>
